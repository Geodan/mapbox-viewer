<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title></title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='node_modules/proj4/dist/proj4-src.js'></script>
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.37.0/mapbox-gl.css' rel='stylesheet' />
    <style>
        body { margin:0; padding:0; }
        #map { position:absolute; top:0; bottom:0; width:100%; }
        #legend { position: absolute; top: 1em; right: 1em; width: 20%; max-width: 200px; background-color: white; border: 1px solid gray; padding: 1em;}
    </style>
</head>
<body>

<div id='map'></div>
<div id='legend'><img src="http://localhost:8080/mapproxy/cbsadministratief/wms?service=wms&version=1.3.0&request=getLegendGraphic&layer=CBSbevolking2017&format=image/png"></div>
<script>
//mapboxgl.accessToken = 'pk.eyJ1IjoiYW5uZWIiLCJhIjoiOVR1NFVoRSJ9.x0d9OLRZADt-GJaDqE0XPg';
var map = new mapboxgl.Map({
    container: 'map',
    zoom: 9,
     center: [4.913196, 52.342259],
    style: "styles/qgis.json",
    hash: false
});

var data = {"type": "Feature", "properties": {}, "geometry": { "type": "LineString", "coordinates": [[0,0],[0,1]]}};
//var data = {"type": "Feature", "properties": {}, "geometry": {}};

map.on('load', () => {
	map.addControl(new mapboxgl.ScaleControl({position: 'bottom-left'}));
    map.addSource('selectedfeature', { type: 'geojson', data: data});
    map.addLayer({
        "id": "selectedfeature",
        "type": "line",
        "source": "selectedfeature",
        "paint": {
            "line-color": "red",
            "line-opacity": 0.75,
            "line-width": 2
        }
    });
});

// srs optional, defaults to 'EPSG:3857'
// adds projected .x and .y properties to lngLat
function projectLngLat(lngLat, srs)
{
    if (!srs) {
        srs = 'EPSG:3857';
    }
    var project = proj4('EPSG:4326', srs);
    var p = project.forward({x: lngLat.lng, y: lngLat.lat});    
    lngLat.x = p.x;
    lngLat.y = p.y;
    return lngLat;
}

function XMLtoGeoJSON(xmlString)
{
    var result = {"type": "FeatureCollection", "features": []};
    var parser = new DOMParser();
    var xmlDoc = parser.parseFromString(xmlString,"text/xml");
    var root = xmlDoc.getElementsByTagName("GetFeatureInfoResponse");
    if (root && root.length) {
        var layers = root[0].getElementsByTagName("Layer");
        var layerInfo = {};
        for (var i = 0; i < layers.length; i++) {
            layerInfo.name = layers[i].getAttribute('name');
            var features = layers[i].getElementsByTagName('Feature');
            if (features && features.length) {
                for (var j = 0; j < features.length; j++) {
                    var featureInfo = {};                  
                    featureInfo.properties = {};
                    var attributes = features[j].getElementsByTagName('Attribute');
                    if (attributes && attributes.length) {
                        for (var k = 0; k < attributes.length; k++) {
                            var attrName = attributes[k].getAttribute('name');
                            if (attrName != 'geometry') {
                                featureInfo.properties[attrName] = attributes[k].getAttribute('value');
                            } else {
                                var geometryString = attributes[k].getAttribute('value');
                                var endPos = geometryString.indexOf('(');
                                var type = geometryString.substring(0, endPos).trim();
                                geometryString = geometryString.substring(endPos).replace(/\),\(/g, ') (').replace(/, /g, ',').replace(/,/g, '],[').replace(/\(/g, '[').replace(/\)/g, ']').replace(/ /g, ',');
                                featureInfo.geometry = {"type": type, "coordinates": [JSON.parse(geometryString)]};
                            }
                        }
                    }
                    
                    featureObject = {"type": "Feature", "properties": featureInfo.properties, "geometry": featureInfo.geometry, "layername": layerInfo.name};
                    
                    var bBoxInfo = {};
                    var boundingBox = features[j].getElementsByTagName('BoundingBox');
                    if (boundingBox && boundingBox.length) {
                        bBoxInfo.left = boundingBox[0].getAttribute('minx');
                        bBoxInfo.right = boundingBox[0].getAttribute('maxx');
                        bBoxInfo.top = boundingBox[0].getAttribute('maxy');
                        bBoxInfo.bottom = boundingBox[0].getAttribute('miny');
                        bBoxInfo.srs = boundingBox[0].getAttribute('SRS');
                        featureObject.bbox = [parseFloat(bBoxInfo.left), parseFloat(bBoxInfo.bottom), parseFloat(bBoxInfo.right), parseFloat(bBoxInfo.top)];
                    }
                    
                    if (result.crs) {
                        if (bBoxInfo.srs != result.crs.properties.name) {
                            // set deviating feature crs
                            featureObject.crs = {"type": "name", "properties": {"name": bBoxInfo.srs}}
                        }
                    } else {
                        if (bBoxInfo.srs) {
                            // set global GeoJSON crs
                            result.crs = {"type": "name", "properties": {"name": bBoxInfo.srs}}
                        }
                    }
                    result.features.push(featureObject);
                }
            }
        }        
    } else {
        // unknown xml format or not xml?
    }
    return result;
}

function transformArray(project, array)
{
    for (var i = 0; i < array.length; i++) {
        if (typeof array[i] != 'number') {
            transformArray(project, array[i]);
        } else {
            if (i % 2 == 0) {
                var p = project.forward([array[i], array[i+1]]);
                array[i] = p[0];
                array[i+1] = p[1];
                i++;
            }
        }
    }    
}

function geoJSONTransform(geoJSON, inSRS, outSRS)
{
    var project = proj4(inSRS, outSRS);
    if (geoJSON.crs) {
        geoJSON.crs.properties.name = outSRS;
    }
    geoJSON.features.forEach(function(feature){
        transformArray(project, feature.geometry.coordinates);
        if (feature.bbox) {
            transformArray(project, feature.bbox);
        }        
    });
    return geoJSON;
}

function getFeatureInfo(lngLat, callback){
    var clickedPoint = map.project(lngLat);
    var leftbottom = projectLngLat(map.unproject({x: 0, y: map.getCanvas().height}));
    var righttop = projectLngLat(map.unproject({x: map.getCanvas().width, y: 0}));

    var url="http://localhost:8080/mapproxy/cbsadministratief/wms?styles=&format=png&request=GetFeatureInfo&layers=CBSbevolking2017&query_layers=CBSbevolking2017&width="+map.getCanvas().width+"&height="+map.getCanvas().height+"&x="+Math.round(clickedPoint.x)+"&y="+Math.round(clickedPoint.y)+"&version=1.1.1&srs=epsg:3857&info_format=text/xml&bbox="+(leftbottom.x)+","+(leftbottom.y)+","+(righttop.x)+","+(righttop.y)
    
    var xhr = new XMLHttpRequest();
    xhr.onreadystatechange = function() {
      if (xhr.readyState == XMLHttpRequest.DONE) {
          if (callback) {
              callback(XMLtoGeoJSON(xhr.responseText));
          }                 
      }
    }
    xhr.open('GET', url, true);
    xhr.send(null);
}
map.on('click', function (e) {
        console.log(e);
        getFeatureInfo(e.lngLat, function(data){
            if (data && data.crs) {
                if (data.crs.properties.name.toUpperCase() != 'EPSG:4326') {
                    data = geoJSONTransform(data, data.crs.properties.name, 'EPSG:4326');
                }
            }
            console.log(JSON.stringify(data));
            map.getSource('selectedfeature').setData(data);
        });
    });


</script>

</body>
</html>
